<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ethik-Labor: Statistiken</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        header {
            background: white;
            border-radius: 20px;
            padding: 30px 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .header-left h1 { color: #667eea; font-size: 2em; margin-bottom: 5px; }
        .header-left p { color: #666; }

        .back-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .back-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4); }

        .content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h2 { color: #333; margin-bottom: 10px; font-size: 2em; }
        .subtitle { color: #666; margin-bottom: 30px; font-size: 1.1em; }

        .loading {
            text-align: center;
            padding: 60px;
            color: #667eea;
            font-size: 1.2em;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .stat-number { font-size: 3em; font-weight: bold; margin-bottom: 10px; }
        .stat-label { font-size: 1.1em; opacity: 0.9; }

        .dilemma-section {
            margin: 40px 0;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 3px solid #e0e0e0;
        }

        .dilemma-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .dilemma-icon { font-size: 1.5em; }

        .chart-container {
            margin: 30px 0;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .bar-item {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .bar-label {
            min-width: 200px;
            font-weight: 500;
            color: #333;
            font-size: 0.95em;
        }

        .bar-wrapper {
            flex: 1;
            height: 40px;
            background: #e0e0e0;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            transition: width 1s ease-out;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 15px;
            color: white;
            font-weight: bold;
            min-width: 30px;
        }

        .bar-percentage {
            font-size: 0.9em;
        }

        .persona-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .persona-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }

        .persona-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
        }

        .persona-name {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .persona-count {
            color: #666;
            font-size: 0.9em;
        }

        .no-data {
            text-align: center;
            padding: 60px;
            color: #999;
            font-size: 1.2em;
        }

        .insights-box {
            background: #e8f0fe;
            border-left: 5px solid #667eea;
            padding: 25px;
            border-radius: 10px;
            margin: 30px 0;
        }

        .insights-title {
            color: #667eea;
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .insights-text {
            color: #555;
            line-height: 1.8;
        }

        .framework-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .framework-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
        }

        .framework-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .framework-click-count {
            color: #667eea;
            font-size: 2em;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            header { flex-direction: column; text-align: center; }
            .back-btn { margin-top: 20px; }
            .stats-overview { grid-template-columns: 1fr; }
            .bar-label { min-width: 120px; font-size: 0.85em; }
            .persona-stats, .framework-stats { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <h1>üìä Statistiken</h1>
                <p>Was haben andere entschieden?</p>
            </div>
            <a href="dashboard.html" class="back-btn">‚Üê Zur√ºck zum Dashboard</a>
        </header>

        <div class="content">
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Lade Statistiken...</p>
            </div>

            <div id="stats-content" style="display: none;">
                <h2>Gesamt√ºbersicht</h2>
                <p class="subtitle">Alle Entscheidungen im Ethik-Labor</p>

                <div class="stats-overview">
                    <div class="stat-card">
                        <div class="stat-number" id="total-decisions">0</div>
                        <div class="stat-label">Entscheidungen</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-users">0</div>
                        <div class="stat-label">Teilnehmende</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avg-time">0s</div>
                        <div class="stat-label">√ò Entscheidungszeit</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-frameworks">0</div>
                        <div class="stat-label">Framework-Klicks</div>
                    </div>
                </div>

                <!-- Migration Dilemma Statistics -->
                <div class="dilemma-section" id="migration-stats">
                    <div class="dilemma-title">
                        <span class="dilemma-icon">üåç</span>
                        <span>Zwischen Welten - Entscheidungsverteilung</span>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">Was haben die Teilnehmenden entschieden?</div>
                        <div class="bar-chart" id="decision-chart"></div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">Welche Personas wurden zugewiesen?</div>
                        <div class="persona-stats" id="persona-chart"></div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">Welche Ethik-Frameworks wurden angeschaut?</div>
                        <div class="framework-stats" id="framework-chart"></div>
                    </div>

                    <div class="insights-box" id="insights">
                        <div class="insights-title">üí° Erkenntnisse</div>
                        <div class="insights-text" id="insights-text">
                            Lade Insights...
                        </div>
                    </div>
                </div>

                <div id="no-data" class="no-data" style="display: none;">
                    <p>üì≠ Noch keine Daten vorhanden</p>
                    <p style="margin-top: 10px; font-size: 0.9em; color: #999;">Sei der/die Erste und triff eine Entscheidung!</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from './config.js';
        import { collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Entscheidungslabels
        const decisionLabels = {
            'family': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familie & Tradition',
            'compromise': '‚öñÔ∏è Kompromiss',
            'career': 'üéØ Karriere & Unabh√§ngigkeit',
            'delay': '‚è∞ Zeit f√ºr Entscheidung',
            'community': 'ü§ù Gemeinschaftsl√∂sung'
        };

        const frameworkLabels = {
            'utilitarismus': 'Utilitarismus',
            'kant': 'Deontologie (Kant)',
            'tugend': 'Tugendethik',
            'kommunitarismus': 'Kommunitarismus'
        };

        async function loadStatistics() {
            try {
                // Lade alle Entscheidungen
                const decisionsSnapshot = await getDocs(collection(db, 'decisions'));
                const decisions = [];
                
                decisionsSnapshot.forEach(doc => {
                    decisions.push({ id: doc.id, ...doc.data() });
                });

                console.log('üìä Loaded decisions:', decisions.length);

                if (decisions.length === 0) {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('no-data').style.display = 'block';
                    return;
                }

                // Berechne Statistiken
                const stats = calculateStatistics(decisions);
                
                // Zeige Statistiken an
                displayStatistics(stats, decisions);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('stats-content').style.display = 'block';

            } catch (error) {
                console.error('‚ùå Error loading statistics:', error);
                document.getElementById('loading').innerHTML = `
                    <p style="color: #e74c3c;">‚ö†Ô∏è Fehler beim Laden der Statistiken</p>
                    <p style="font-size: 0.9em; margin-top: 10px;">Bitte √ºberpr√ºfe deine Firebase-Konfiguration</p>
                `;
            }
        }

        function calculateStatistics(decisions) {
            const stats = {
                totalDecisions: decisions.length,
                uniqueUsers: new Set(decisions.map(d => d.username)).size,
                avgTime: Math.round(decisions.reduce((sum, d) => sum + (d.timeSpent || 0), 0) / decisions.length),
                decisionCounts: {},
                personaCounts: {},
                frameworkClicks: {},
                totalFrameworkClicks: 0
            };

            decisions.forEach(decision => {
                // Z√§hle Entscheidungen
                const choice = decision.decision;
                stats.decisionCounts[choice] = (stats.decisionCounts[choice] || 0) + 1;

                // Z√§hle Personas
                const persona = decision.persona;
                if (persona) {
                    stats.personaCounts[persona] = (stats.personaCounts[persona] || 0) + 1;
                }

                // Z√§hle Framework-Klicks
                if (decision.frameworksClicked) {
                    decision.frameworksClicked.forEach(fw => {
                        stats.frameworkClicks[fw] = (stats.frameworkClicks[fw] || 0) + 1;
                        stats.totalFrameworkClicks++;
                    });
                }
            });

            return stats;
        }

        function displayStatistics(stats, decisions) {
            // Gesamt√ºbersicht
            document.getElementById('total-decisions').textContent = stats.totalDecisions;
            document.getElementById('total-users').textContent = stats.uniqueUsers;
            document.getElementById('avg-time').textContent = `${stats.avgTime}s`;
            document.getElementById('total-frameworks').textContent = stats.totalFrameworkClicks;

            // Entscheidungsverteilung (Bar Chart)
            const decisionChart = document.getElementById('decision-chart');
            const sortedDecisions = Object.entries(stats.decisionCounts)
                .sort((a, b) => b[1] - a[1]);

            sortedDecisions.forEach(([decision, count]) => {
                const percentage = Math.round((count / stats.totalDecisions) * 100);
                
                const barItem = document.createElement('div');
                barItem.className = 'bar-item';
                barItem.innerHTML = `
                    <div class="bar-label">${decisionLabels[decision] || decision}</div>
                    <div class="bar-wrapper">
                        <div class="bar-fill" style="width: ${percentage}%">
                            <span class="bar-percentage">${count} (${percentage}%)</span>
                        </div>
                    </div>
                `;
                decisionChart.appendChild(barItem);
            });

            // Persona-Verteilung
            const personaChart = document.getElementById('persona-chart');
            Object.entries(stats.personaCounts)
                .sort((a, b) => b[1] - a[1])
                .forEach(([persona, count]) => {
                    const card = document.createElement('div');
                    card.className = 'persona-card';
                    card.innerHTML = `
                        <div class="persona-name">${persona}</div>
                        <div class="persona-count">${count} Zuweisungen (${Math.round((count / stats.totalDecisions) * 100)}%)</div>
                    `;
                    personaChart.appendChild(card);
                });

            // Framework-Verteilung
            const frameworkChart = document.getElementById('framework-chart');
            Object.entries(stats.frameworkClicks)
                .sort((a, b) => b[1] - a[1])
                .forEach(([framework, count]) => {
                    const card = document.createElement('div');
                    card.className = 'framework-card';
                    card.innerHTML = `
                        <div class="framework-name">${frameworkLabels[framework] || framework}</div>
                        <div class="framework-click-count">${count}√ó</div>
                        <div style="color: #999; font-size: 0.9em; margin-top: 5px;">angeklickt</div>
                    `;
                    frameworkChart.appendChild(card);
                });

            // Generiere Insights
            generateInsights(stats, decisions);
        }

        function generateInsights(stats, decisions) {
            const insightsText = document.getElementById('insights-text');
            const insights = [];

            // Beliebteste Entscheidung
            const mostPopular = Object.entries(stats.decisionCounts)
                .sort((a, b) => b[1] - a[1])[0];
            
            if (mostPopular) {
                const percentage = Math.round((mostPopular[1] / stats.totalDecisions) * 100);
                insights.push(`<strong>${percentage}%</strong> entschieden sich f√ºr <strong>${decisionLabels[mostPopular[0]]}</strong> - die beliebteste Wahl.`);
            }

            // Durchschnittliche Entscheidungszeit
            if (stats.avgTime > 0) {
                if (stats.avgTime > 180) {
                    insights.push(`Die durchschnittliche Entscheidungszeit von <strong>${Math.round(stats.avgTime / 60)} Minuten</strong> zeigt, dass Teilnehmende sich intensiv mit dem Dilemma auseinandergesetzt haben.`);
                } else {
                    insights.push(`Mit durchschnittlich <strong>${stats.avgTime} Sekunden</strong> Entscheidungszeit haben die meisten schnell eine Wahl getroffen.`);
                }
            }

            // Framework-Nutzung
            const frameworkUsageRate = Math.round((stats.totalFrameworkClicks / stats.totalDecisions) * 100);
            if (frameworkUsageRate > 150) {
                insights.push(`<strong>${frameworkUsageRate}%</strong> Framework-Nutzung - Teilnehmende schauten sich durchschnittlich mehrere ethische Perspektiven an!`);
            } else if (frameworkUsageRate > 50) {
                insights.push(`<strong>${frameworkUsageRate}%</strong> der Teilnehmenden klickten mindestens ein ethisches Framework an.`);
            }

            // Beliebtestes Framework
            if (Object.keys(stats.frameworkClicks).length > 0) {
                const mostClickedFramework = Object.entries(stats.frameworkClicks)
                    .sort((a, b) => b[1] - a[1])[0];
                insights.push(`<strong>${frameworkLabels[mostClickedFramework[0]]}</strong> war das meistgelesene ethische Framework mit ${mostClickedFramework[1]} Klicks.`);
            }

            insightsText.innerHTML = insights.join('<br><br>');
        }

        // Lade Statistiken beim Seitenaufruf
        loadStatistics();
    </script>
</body>
</html>
